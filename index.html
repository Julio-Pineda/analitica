<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíôDashboard Anal√≠tico</title>
    
    <!-- Bootstrap 5 CSS y Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- DataTables con tema Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">

    <style>
        body {
            background-color: #f4f7fc;
        }
        .card {
            border: none;
            border-radius: 22px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            height: 100%; /* Permite que las tarjetas en la misma fila se alineen en altura */
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 10px 10px 23px 6px rgba(0, 0, 0, 0.496)!important;
        }

        .card-body{
            border-radius: 22px;
        }

        .upload-card {
             border-style: dashed;
             border-color: #0d6efd;
        }
        .plot-container {
            width: 100%;
            /* Se elimin√≥ la altura m√≠nima para que las tarjetas sean ce√±idas */
        }
        .kpi-card .card-body {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kpi-icon {
            font-size: 2.5rem;
            margin-right: 1.5rem;
            color: #0d6efd;
        }
        .col-lg-6, .col-md-6, .col-md-4 {
            margin-bottom: 44px;
        }
    </style>
</head>
<body>

    <main class="container mt-4">
        <header class="text-center mb-5">
            <h1 class="display-4">ESTAD√çSTICAS</h1>
            <p class="lead text-muted">üíôDisfruta de una visualizaci√≥n agradable de los datos</p>
        </header>

        <section class="row mb-4">
            <div class="col-12">
                <div class="card upload-card shadow-sm">
                    <div class="card-body text-center p-4">
                        <h5 class="card-title">Cargar Datos</h5>
                        <p class="card-text">Selecciona uno o varios archivos .JSON para comenzar el an√°lisis.</p>
                        <input type="file" id="jsonInput" class="form-control" accept=".json" multiple />
                        <div id="loader" class="d-none spinner-border text-primary mt-3" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- El dashboard y sus filas se generar√°n din√°micamente aqu√≠ -->
        <section id="dashboard-container">
        </section>
    </main>

    <!-- JS: Plotly, jQuery, Bootstrap, DataTables -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>

    <script>
        // --- CONFIGURACI√ìN GLOBAL ---
        const plotlyBaseLayout = { font: { family: 'Segoe UI, sans-serif', size: 12, color: '#333' }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)' };
        const dataTablesSpanish = { "sProcessing": "Procesando...", "sLengthMenu": "Mostrar _MENU_ registros", "sZeroRecords": "No se encontraron resultados", "sEmptyTable": "Ning√∫n dato disponible en esta tabla", "sInfo": "Mostrando _START_ al _END_ de _TOTAL_ registros", "sInfoEmpty": "Mostrando 0 de 0 registros", "sInfoFiltered": "(filtrado de un total de _MAX_ registros)", "sSearch": "Buscar:", "oPaginate": { "sFirst": "Primero", "sLast": "√öltimo", "sNext": "Siguiente", "sPrevious": "Anterior" } };

        // --- ELEMENTOS DEL DOM ---
        const jsonInput = document.getElementById('jsonInput');
        const dashboardContainer = document.getElementById('dashboard-container');
        const loader = document.getElementById('loader');

        // --- L√ìGICA PRINCIPAL ---
        function showInitialState() {
            dashboardContainer.innerHTML = `<div class="row g-4"><div class="col-12"><div class="card text-center bg-light"><div class="card-body p-5"><i class="bi bi-bar-chart-line" style="font-size: 3rem; color: #6c757d;"></i><h5 class="card-title mt-3">Esperando datos</h5><p class="card-text">Tus visualizaciones aparecer√°n aqu√≠ una vez que cargues los archivos.</p></div></div></div></div>`;
        }
        showInitialState();

        jsonInput.addEventListener('change', function(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            loader.classList.remove('d-none');
            jsonInput.disabled = true;
            const filePromises = Array.from(files).map(file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => { try { resolve(JSON.parse(e.target.result)); } catch (error) { reject(`Error en archivo ${file.name}: ${error.message}`); } };
                reader.onerror = () => reject(`No se pudo leer el archivo ${file.name}`);
                reader.readAsText(file);
            }));
            Promise.all(filePromises)
                .then(results => { renderDashboard([].concat.apply([], results)); })
                .catch(error => { alert(error); showInitialState(); })
                .finally(() => { loader.classList.add('d-none'); jsonInput.disabled = false; });
        });

        function renderDashboard(data) {
            dashboardContainer.innerHTML = ''; // Limpiar todo el contenedor
            
            // Crear filas dedicadas para cada secci√≥n del dashboard
            const kpiRow = createRow(dashboardContainer);
            const donutRow = createRow(dashboardContainer);
            const barRow1 = createRow(dashboardContainer);
            const barRow2 = createRow(dashboardContainer);
            const fullTableRow = createRow(dashboardContainer);

            // Poblar las filas
            const iglesias = groupBy(data, 'Iglesia');
            const categorias = groupBy(data, 'categoria');
            renderSummaryCards({ totalPersonas: data.length, totalCategorias: Object.keys(categorias).length, totalIglesias: Object.keys(iglesias).length }, kpiRow);
            
            const suscritos = data.filter(p => p["Suscrito a InfoMIRA"] === "Suscrito ‚úÖ").length;
            createDonutChart('Estado de Suscripci√≥n', ['Suscritos ‚úÖ', 'No Suscritos'], [suscritos, data.length - suscritos], 'col-md-6', donutRow);
            
            const lideresActivos = data.filter(p => p["Es L√≠der"] === "S√≠, Activo ‚úÖ").length;
            createDonutChart('Estado de Liderazgo', ['L√≠deres Activos ‚úÖ', 'No L√≠deres'], [lideresActivos, data.length - lideresActivos], 'col-md-6', donutRow);
            
            createBarChartAndTable('Distribuci√≥n por Categor√≠a', 'categoria', categorias, 'col-lg-6', barRow1);
            createBarChartAndTable('Distribuci√≥n por Iglesia', 'Iglesia', iglesias, 'col-lg-6', barRow1);
            
            createBarChartAndTable('Distribuci√≥n por Puesto de Votaci√≥n', 'Puesto de votaci√≥n', groupBy(data, 'Puesto de votaci√≥n'), 'col-lg-12', barRow2);
            
            createFullDataTable(data, 'col-12', fullTableRow);
        }
        
        // --- FUNCIONES DE CREACI√ìN DE COMPONENTES ---

        function renderSummaryCards(stats, parentElement) {
            parentElement.innerHTML = `<div class="col-md-4 mb-2"><div class="card shadow-sm kpi-card"><div class="card-body"><i class="bi bi-people-fill kpi-icon"></i><div><h5>Total Personas</h5><h3 class="fw-bold">${stats.totalPersonas}</h3></div></div></div></div><div class="col-md-4"><div class="card shadow-sm kpi-card"><div class="card-body"><i class="bi bi-tags-fill kpi-icon"></i><div><h5>Total Categor√≠as</h5><h3 class="fw-bold">${stats.totalCategorias}</h3></div></div></div></div><div class="col-md-4"><div class="card shadow-sm kpi-card"><div class="card-body"><i class="bi bi-bank kpi-icon"></i><div><h5>Total Iglesias</h5><h3 class="fw-bold">${stats.totalIglesias}</h3></div></div></div></div>`;
        }

        function createDonutChart(title, labels, values, colClass, parentElement) {
            const { cardBody } = createCardCol(colClass, title, parentElement);
            const plotContainer = document.createElement('div');
            plotContainer.className = 'plot-container';
            cardBody.appendChild(plotContainer);
            const plotData = [{ values, labels, type: 'pie', hole: .4, hoverinfo: 'label+percent', textinfo: 'value', marker: { colors: ['#0d6efd', '#adb5bd'] } }];
            const layout = { ...plotlyBaseLayout, showlegend: true, legend: { x: 0.5, xanchor: 'center', y: -0.2, orientation: 'h' }, margin: { l: 20, r: 20, b: 60, t: 60 } };
            Plotly.newPlot(plotContainer, plotData, layout, { responsive: true });
        }

        function createBarChartAndTable(title, keyName, groupedData, colClass, parentElement) {
            const { cardBody } = createCardCol(colClass, title, parentElement);

            const plotContainer = document.createElement('div');
            plotContainer.className = 'plot-container';
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-responsive mt-3';
            cardBody.appendChild(plotContainer);
            cardBody.appendChild(tableContainer);

            const names = Object.keys(groupedData);
            const counts = names.map(name => groupedData[name].length);
            const min = Math.min(...counts), max = Math.max(...counts);
            const colors = counts.map(val => getColorForValue(val, min, max));
            const hoverText = names.map((name, i) => `${keyName}: ${name}<br>Cantidad: ${counts[i]}`);
            const plotData = [{ x: names, y: counts, type: 'bar', marker: { color: colors }, hoverinfo: 'text', hovertext: hoverText }];
            const layout = { ...plotlyBaseLayout, yaxis: { title: 'Cantidad', automargin: true }, margin: { l: 60, r: 20, b: 80, t: 40 } };
            Plotly.newPlot(plotContainer, plotData, layout, { responsive: true });
            
            const tableId = `table-${keyName.replace(/[^a-zA-Z0-9]/g, '')}`;
            tableContainer.innerHTML = `<table id="${tableId}" class="table table-striped table-bordered" style="width:100%"><thead><tr><th>${keyName}</th><th>Personas</th></tr></thead></table>`;
            const tableData = names.map((name, index) => [name, counts[index]]);
            new DataTable(`#${tableId}`, { data: tableData, language: dataTablesSpanish });
        }

        function createFullDataTable(fullData, colClass, parentElement) {
            if (!fullData || fullData.length === 0) return;
            const { cardBody } = createCardCol(colClass, 'Tabla de Datos Completa', parentElement);
            const headers = Object.keys(fullData[0]);
            let headerHtml = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            cardBody.innerHTML = `<div class="table-responsive"><table id="fullDataTable" class="table table-striped table-bordered" style="width:100%"><thead>${headerHtml}</thead></table></div>`;
            const tableData = fullData.map(item => headers.map(header => item[header] || '-'));
            new DataTable('#fullDataTable', { data: tableData, language: dataTablesSpanish, scrollX: true });
        }
        
        // --- FUNCIONES DE UTILIDAD ---
        function createRow(container) {
            const row = document.createElement('div');
            row.className = 'row g-4';
            container.appendChild(row);
            return row;
        }

        function createCardCol(colClass, title, parentElement) {
            const col = document.createElement('div');
            col.className = colClass;
            const card = document.createElement('div');
            card.className = 'card shadow-sm';
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            if (title) {
                const titleEl = document.createElement('h5');
                titleEl.className = 'card-title text-center';
                titleEl.textContent = title;
                cardBody.appendChild(titleEl);
            }
            card.appendChild(cardBody);
            col.appendChild(card);
            parentElement.appendChild(col);
            return { cardBody };
        }

        function groupBy(array, key) {
            return array.reduce((result, currentValue) => {
                const groupKey = currentValue[key] || "No definido";
                (result[groupKey] = result[groupKey] || []).push(currentValue);
                return result;
            }, {});
        }

        function getColorForValue(value, min, max) {
            if (min === max) return 'rgb(13, 110, 253)';
            const percent = (max - min) === 0 ? 1 : (value - min) / (max - min);
            const red = [220, 53, 69], yellow = [255, 193, 7], blue = [13, 110, 253];
            let r, g, b;
            if (percent < 0.5) {
                const localPercent = percent * 2;
                r = Math.round(red[0] + localPercent * (yellow[0] - red[0])); g = Math.round(red[1] + localPercent * (yellow[1] - red[1])); b = Math.round(red[2] + localPercent * (yellow[2] - red[2]));
            } else {
                const localPercent = (percent - 0.5) * 2;
                r = Math.round(yellow[0] + localPercent * (blue[0] - yellow[0])); g = Math.round(yellow[1] + localPercent * (blue[1] - yellow[1])); b = Math.round(yellow[2] + localPercent * (blue[2] - yellow[2]));
            }
            return `rgb(${r},${g},${b})`;
        }
    </script>
</body>
</html>